
#include "TopNtupleAnalysis/EFTLib.h"

#include <cmath>
#include <complex>
#include <vector>
#include "TopNtupleAnalysis/HelAmps_TopEffTh.h"
#include "TopNtupleAnalysis/HelAmps_sm.h"

#include "TopNtupleAnalysis/Parameters_TopEffTh.h"
#include "TopNtupleAnalysis/Parameters_sm.h"


namespace EFT_gg_ttx {
#include "TopNtupleAnalysis/EFTIncludes/P1_Sigma_TopEffTh_gg_ttx/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P1_Sigma_TopEffTh_gg_ttx/CPPProcess.cc"
CPPProcess process;
}
namespace EFT_uux_ttx {
#include "TopNtupleAnalysis/EFTIncludes/P1_Sigma_TopEffTh_uux_ttx/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P1_Sigma_TopEffTh_uux_ttx/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_uux_ttxg {
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_TopEffTh_uux_ttxg/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_TopEffTh_uux_ttxg/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_gg_ttxg {
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_TopEffTh_gg_ttxg/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_TopEffTh_gg_ttxg/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_gu_ttxu {
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_TopEffTh_gu_ttxu/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_TopEffTh_gu_ttxu/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_gux_ttxux {
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_TopEffTh_gux_ttxux/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_TopEffTh_gux_ttxux/CPPProcess.cc"
CPPProcess process;
}

// ttjj
namespace EFT_gg_ttxgg {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_gg_ttxgg/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_gg_ttxgg/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_gg_ttxuux {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_gg_ttxuux/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_gg_ttxuux/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_uu_ttxuu {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_uu_ttxuu/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_uu_ttxuu/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_uxux_ttxuxux {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_uxux_ttxuxux/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_uxux_ttxuxux/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_uux_ttxuux {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_uux_ttxuux/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_uux_ttxuux/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_uux_ttxgg {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_uux_ttxgg/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_uux_ttxgg/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_gu_ttxgu {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_gu_ttxgu/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_gu_ttxgu/CPPProcess.cc"
CPPProcess process;
}

namespace EFT_gux_ttxgux {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_gux_ttxgux/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_TopEffTh_gux_ttxgux/CPPProcess.cc"
CPPProcess process;
}


// SM tt


namespace SM_gg_ttx {
#include "TopNtupleAnalysis/EFTIncludes/P1_Sigma_sm_gg_ttx/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P1_Sigma_sm_gg_ttx/CPPProcess.cc"
CPPProcess process;
}

namespace SM_uux_ttx {
#include "TopNtupleAnalysis/EFTIncludes/P1_Sigma_sm_uux_ttx/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P1_Sigma_sm_uux_ttx/CPPProcess.cc"
CPPProcess process;
}

// tt1j

namespace SM_gg_ttxg {
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_sm_gg_ttxg/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_sm_gg_ttxg/CPPProcess.cc"
CPPProcess process;
}

namespace SM_uux_ttxg {
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_sm_uux_ttxg/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_sm_uux_ttxg/CPPProcess.cc"
CPPProcess process;
}

namespace SM_gu_ttxu {
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_sm_gu_ttxu/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_sm_gu_ttxu/CPPProcess.cc"
CPPProcess process;
}

namespace SM_gux_ttxux {
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_sm_gux_ttxux/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P2_Sigma_sm_gux_ttxux/CPPProcess.cc"
CPPProcess process;
}

// ttjj
namespace SM_gg_ttxgg {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_gg_ttxgg/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_gg_ttxgg/CPPProcess.cc"
CPPProcess process;
}

namespace SM_gg_ttxuux {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_gg_ttxuux/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_gg_ttxuux/CPPProcess.cc"
CPPProcess process;
}

namespace SM_uu_ttxuu {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_uu_ttxuu/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_uu_ttxuu/CPPProcess.cc"
CPPProcess process;
}

namespace SM_uxux_ttxuxux {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_uxux_ttxuxux/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_uxux_ttxuxux/CPPProcess.cc"
CPPProcess process;
}

namespace SM_uux_ttxuux {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_uux_ttxuux/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_uux_ttxuux/CPPProcess.cc"
CPPProcess process;
}

namespace SM_uux_ttxgg {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_uux_ttxgg/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_uux_ttxgg/CPPProcess.cc"
CPPProcess process;
}

namespace SM_gu_ttxgu {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_gu_ttxgu/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_gu_ttxgu/CPPProcess.cc"
CPPProcess process;
}

namespace SM_gux_ttxgux {
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_gux_ttxgux/CPPProcess.h"
#include "TopNtupleAnalysis/EFTIncludes/P3_Sigma_sm_gux_ttxgux/CPPProcess.cc"
CPPProcess process;
}



//#include "LHAPDF/LHAPDF.h"
//using namespace LHAPDF;

const PDF *m_pdf = 0;

double alphas(const double scale2) {
  double mZ2 = std::pow(91.1888, 2);
  double alphasMZ = 0.118;
  
  double nf = 5;
  double b0 = (33.0 - 2.0*nf)/12.0/TMath::Pi();
  double als = alphasMZ/(1.0 + alphasMZ*b0*std::log(scale2/mZ2));
  return als;
}

void initPDFForReweighting(const std::string &s, int id) {
  m_pdf = mkPDF(s.c_str(), id);
}

double pdfAlphaS(double Q2) {
  return m_pdf->alphasQ2(Q2);
}

void initEFTModels(float lambda, float cvv) {
  EFT_gg_ttx::process.initProc("param_card_eft.dat");
  EFT_uux_ttx::process.initProc("param_card_eft.dat");

  EFT_gg_ttxg::process.initProc("param_card_eft.dat");
  EFT_uux_ttxg::process.initProc("param_card_eft.dat");
  EFT_gu_ttxu::process.initProc("param_card_eft.dat");
  EFT_gux_ttxux::process.initProc("param_card_eft.dat");

  EFT_gg_ttxgg::process.initProc("param_card_eft.dat");
  EFT_gg_ttxuux::process.initProc("param_card_eft.dat");
  EFT_uu_ttxuu::process.initProc("param_card_eft.dat");
  EFT_uxux_ttxuxux::process.initProc("param_card_eft.dat");
  EFT_uux_ttxuux::process.initProc("param_card_eft.dat");
  EFT_uux_ttxgg::process.initProc("param_card_eft.dat");
  EFT_gu_ttxgu::process.initProc("param_card_eft.dat");
  EFT_gux_ttxgux::process.initProc("param_card_eft.dat");

  SM_gg_ttx::process.initProc("param_card_sm.dat");
  SM_uux_ttx::process.initProc("param_card_sm.dat");

  SM_gg_ttxg::process.initProc("param_card_sm.dat");
  SM_uux_ttxg::process.initProc("param_card_sm.dat");
  SM_gu_ttxu::process.initProc("param_card_sm.dat");
  SM_gux_ttxux::process.initProc("param_card_sm.dat");

  SM_gg_ttxgg::process.initProc("param_card_sm.dat");
  SM_gg_ttxuux::process.initProc("param_card_sm.dat");
  SM_uu_ttxuu::process.initProc("param_card_sm.dat");
  SM_uxux_ttxuxux::process.initProc("param_card_sm.dat");
  SM_uux_ttxuux::process.initProc("param_card_sm.dat");
  SM_uux_ttxgg::process.initProc("param_card_sm.dat");
  SM_gu_ttxgu::process.initProc("param_card_sm.dat");
  SM_gux_ttxgux::process.initProc("param_card_sm.dat");

  // override model's parameters
  Parameters_TopEffTh::getInstance()->mdl_Lambda = lambda;
  Parameters_TopEffTh::getInstance()->mdl_Lambda__exp__2 = std::pow(lambda, 2);
  Parameters_TopEffTh::getInstance()->mdl_C81qq = cvv;
  Parameters_TopEffTh::getInstance()->mdl_C1qt = cvv;
  Parameters_TopEffTh::getInstance()->setIndependentCouplings();
}

template <typename C>
double getWeight(C &process, int i1pid, int i2pid, TLorentzVector i1o, TLorentzVector i2o, TLorentzVector to, TLorentzVector tbaro, std::vector<TLorentzVector> f, double Q2 = -1) {
  
  double weight = 0;

  // set mass properly if needed
  TLorentzVector i1, i2, t, tbar;
  i1 = i1o;
  i2 = i2o;
  t = to;
  tbar = tbaro;

  double aS = m_pdf->alphasQ2(Q2);
  Parameters_sm::getInstance()->aS = aS;
  Parameters_TopEffTh::getInstance()->aS = aS;
  Parameters_sm::getInstance()->setDependentParameters();
  Parameters_sm::getInstance()->setDependentCouplings();
  Parameters_TopEffTh::getInstance()->setDependentParameters();
  Parameters_TopEffTh::getInstance()->setDependentCouplings();

  //double i1E = std::sqrt(std::pow(process.getMasses()[0], 2) + std::pow(i1o.Px(), 2) + std::pow(i1o.Py(), 2) + std::pow(i1o.Pz(), 2));
  //double i2E = std::sqrt(std::pow(process.getMasses()[1], 2) + std::pow(i2o.Px(), 2) + std::pow(i2o.Py(), 2) + std::pow(i2o.Pz(), 2));
  //i1.SetPxPyPzE(i1o.Px(), i1o.Py(), i1o.Pz(), i1E);
  //i2.SetPxPyPzE(i2o.Px(), i2o.Py(), i2o.Pz(), i2E);
  //t.SetPtEtaPhiM(to.Pt(), to.Eta(), to.Phi(), process.getMasses()[2]);
  //tbar.SetPtEtaPhiM(tbaro.Pt(), tbaro.Eta(), tbaro.Phi(), process.getMasses()[3]);

  // Get phase space point
  vector<double*> p(4+f.size(), 0);
  p[0] = new double[4];
  p[1] = new double[4];
  p[0][0] = i1.E();
  p[0][1] = i1.Px();
  p[0][2] = i1.Py();
  p[0][3] = i1.Pz();
  p[1][0] = i2.E();
  p[1][1] = i2.Px();
  p[1][2] = i2.Py();
  p[1][3] = i2.Pz();
  p[2] = new double[4];
  p[3] = new double[4];
  p[2][0] = t.E();
  p[2][1] = t.Px();
  p[2][2] = t.Py();
  p[2][3] = t.Pz();
  p[3][0] = tbar.E();
  p[3][1] = tbar.Px();
  p[3][2] = tbar.Py();
  p[3][3] = tbar.Pz();
  for (unsigned int k = 0; k < f.size(); ++k) {
    p[4+k] = new double[4];
    p[4+k][0] = f[k].E();
    p[4+k][1] = f[k].Px();
    p[4+k][2] = f[k].Py();
    p[4+k][3] = f[k].Pz();
  }

  // Set momenta for this event
  process.setMomenta(p);
  process.setInitial(i1pid, i2pid);
  // Evaluate matrix element
  process.sigmaKin();
  //const double* matrix_elements = process.getMatrixElements();

  weight = process.sigmaHat();
  for (unsigned int k = 0; k < p.size(); ++k)
    delete [] p[k];
  p.clear();
  return weight;
};

double getEFTWeight(int i1_pid, int i2_pid, std::vector<int> f_pid, TLorentzVector i1, TLorentzVector i2, TLorentzVector t, TLorentzVector tbar, std::vector<TLorentzVector> f, double Q2, double cvv) {
  Parameters_TopEffTh::getInstance()->mdl_C81qq = cvv;
  Parameters_TopEffTh::getInstance()->mdl_C1qt = cvv;
  Parameters_TopEffTh::getInstance()->setIndependentCouplings();
  if (abs(i1_pid) < 6) {
    if (i1_pid > 0)
      i1_pid = 2;
    if (i1_pid < 0)
      i1_pid = -2;
  }
  if (abs(i2_pid) < 6) {
    if (i2_pid > 0)
      i2_pid = 2;
    if (i2_pid < 0)
      i2_pid = -2;
  }
  for (unsigned int k = 0; k < f_pid.size(); ++k) {
    if (abs(f_pid[k]) < 6) {
      if (f_pid[k] > 0)
        f_pid[k] = 2;
      if (f_pid[k] < 0)
        f_pid[k] = -2;
    }
  }
  if (f_pid.size() == 2) {
    if (abs(f_pid[1]) == 21 || f_pid[0] < 0) {
      int tmp_p = f_pid[0];
      TLorentzVector tmp = f[0];
      f[0] = f[1];
      f_pid[0] = f_pid[1];
      f[1] = tmp;
      f_pid[1] = tmp_p;
    }
  }
  if (abs(i2_pid) == 21 || i1_pid < 0) {
    int tmp_p = i1_pid;
    TLorentzVector tmp = i1;
    i1 = i2;
    i1_pid = i2_pid;
    i2 = tmp;
    i2_pid = tmp_p;
  }
  if (i1_pid == 21 && i2_pid == 21) { // gg-> tt
    if (f_pid.size() == 0) {
      return getWeight<EFT_gg_ttx::CPPProcess>(EFT_gg_ttx::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    } else if (f_pid.size() == 1) {
      if (f_pid[0] == 21)
        return getWeight<EFT_gg_ttxg::CPPProcess>(EFT_gg_ttxg::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    } else if (f_pid.size() == 2) {
      if (f_pid[0] == 21 && f_pid[1] == 21)
        return getWeight(EFT_gg_ttxgg::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      if (abs(f_pid[0]) == 2 && abs(f_pid[1]) == 2)
        return getWeight(EFT_gg_ttxuux::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    }
  } else if (i1_pid == 2 && i2_pid == 2) {
    if (f_pid.size() == 2) {
      if (f_pid[0] == 2 && f_pid[1] == 2) {
        return getWeight(EFT_uu_ttxuu::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      }
    }
  } else if (i1_pid == -2 && i2_pid == -2) {
    if (f_pid.size() == 2) {
      if (f_pid[0] == -2 && f_pid[1] == -2) {
        return getWeight(EFT_uxux_ttxuxux::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      }
    }
  } else if (i1_pid == 2 && i2_pid == -2) {
    if (f_pid.size() == 0) {
      return getWeight<EFT_uux_ttx::CPPProcess>(EFT_uux_ttx::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    } else if (f_pid.size() == 1) {
      if (f_pid[0] == 21)
        return getWeight<EFT_uux_ttxg::CPPProcess>(EFT_uux_ttxg::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    } else if (f_pid.size() == 2) {
      if (f_pid[0] == 2 && f_pid[1] == -2) {
        return getWeight(EFT_uux_ttxuux::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      } else if (f_pid[0] == 21 && f_pid[1] == 21) {
        return getWeight(EFT_uux_ttxgg::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      }
    }
  } else if (i1_pid == 21 && abs(i2_pid) == 2) {
    if (f_pid.size() == 0) {
      std::cout << "This cannot happen! DANGER Will Robinson DANGER!" << std::endl;
      std::cout << "i1 PID is " << i1_pid << ", i2 PID is " << i2_pid << ", but zero extra particles." << std::endl;
      std::exit(-1);
    }
    if (f_pid.size() == 1) {
      if (f_pid[0] == -2 && i2_pid == -2)
        return getWeight<EFT_gux_ttxux::CPPProcess>(EFT_gux_ttxux::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      if (f_pid[0] ==  2 && i2_pid ==  2)
        return getWeight<EFT_gu_ttxu::CPPProcess>(EFT_gu_ttxu::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    } else if (f_pid.size() == 2) {
      if (f_pid[1] == -2 && i2_pid == -2)
        return getWeight<EFT_gux_ttxgux::CPPProcess>(EFT_gux_ttxgux::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      if (f_pid[1] == 2  && i2_pid == 2)
        return getWeight<EFT_gu_ttxgu::CPPProcess>(EFT_gu_ttxgu::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    }
  }
  std::cout << "WARNING: Reached end of getEFTWeight without a weight! This cannot happen. i1 = " << i1_pid << ", i2 = " << i2_pid;
  for (unsigned int k = 0; k < f_pid.size(); ++k) {
    std::cout << ", f" << k << " = " << f_pid[k];
  }
  std::cout << std::endl;
  exit(-1);
  return 0;
}

double getSMWeight(int i1_pid, int i2_pid, std::vector<int> f_pid, TLorentzVector i1, TLorentzVector i2, TLorentzVector t, TLorentzVector tbar, std::vector<TLorentzVector> f, double Q2) {
  if (abs(i1_pid) < 6) {
    if (i1_pid > 0)
      i1_pid = 2;
    if (i1_pid < 0)
      i1_pid = -2;
  }
  if (abs(i2_pid) < 6) {
    if (i2_pid > 0)
      i2_pid = 2;
    if (i2_pid < 0)
      i2_pid = -2;
  }
  for (unsigned int k = 0; k < f_pid.size(); ++k) {
    if (abs(f_pid[k]) < 6) {
      if (f_pid[k] > 0)
        f_pid[k] = 2;
      if (f_pid[k] < 0)
        f_pid[k] = -2;
    }
  }
  if (f_pid.size() == 2) {
    if (abs(f_pid[1]) == 21 || f_pid[0] < 0) {
      int tmp_p = f_pid[0];
      TLorentzVector tmp = f[0];
      f[0] = f[1];
      f_pid[0] = f_pid[1];
      f[1] = tmp;
      f_pid[1] = tmp_p;
    }
  }
  if (abs(i2_pid) == 21 || i1_pid < 0) {
    int tmp_p = i1_pid;
    TLorentzVector tmp = i1;
    i1 = i2;
    i1_pid = i2_pid;
    i2 = tmp;
    i2_pid = tmp_p;
  }
  if (i1_pid == 21 && i2_pid == 21) { // gg-> tt
    if (f_pid.size() == 0) {
      return getWeight<SM_gg_ttx::CPPProcess>(SM_gg_ttx::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    } else if (f_pid.size() == 1) {
      if (f_pid[0] == 21)
        return getWeight<SM_gg_ttxg::CPPProcess>(SM_gg_ttxg::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    } else if (f_pid.size() == 2) {
      if (f_pid[0] == 21 && f_pid[1] == 21)
        return getWeight(SM_gg_ttxgg::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      if (abs(f_pid[0]) == 2 && abs(f_pid[1]) == 2)
        return getWeight(SM_gg_ttxuux::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    }
  } else if (i1_pid == 2 && i2_pid == 2) {
    if (f_pid.size() == 2) {
      if (f_pid[0] == 2 && f_pid[1] == 2) {
        return getWeight(SM_uu_ttxuu::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      }
    }
  } else if (i1_pid == -2 && i2_pid == -2) {
    if (f_pid.size() == 2) {
      if (f_pid[0] == -2 && f_pid[1] == -2) {
        return getWeight(SM_uxux_ttxuxux::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      }
    }
  } else if (i1_pid == 2 && i2_pid == -2) {
    if (f_pid.size() == 0) {
      return getWeight<SM_uux_ttx::CPPProcess>(SM_uux_ttx::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    } else if (f_pid.size() == 1) {
      if (f_pid[0] == 21)
        return getWeight<SM_uux_ttxg::CPPProcess>(SM_uux_ttxg::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    } else if (f_pid.size() == 2) {
      if (f_pid[0] == 2 && f_pid[1] == -2) {
        return getWeight(SM_uux_ttxuux::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      } else if (f_pid[0] == 21 && f_pid[1] == 21) {
        return getWeight(SM_uux_ttxgg::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      }
    }
  } else if (i1_pid == 21 && abs(i2_pid) == 2) {
    if (f_pid.size() == 0) {
      std::cout << "This cannot happen! DANGER Will Robinson DANGER!" << std::endl;
      std::cout << "i1 PID is " << i1_pid << ", i2 PID is " << i2_pid << ", but zero extra particles." << std::endl;
      std::exit(-1);
    }
    if (f_pid.size() == 1) {
      if (f_pid[0] == -2 && i2_pid == -2)
        return getWeight<SM_gux_ttxux::CPPProcess>(SM_gux_ttxux::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      if (f_pid[0] ==  2 && i2_pid ==  2)
        return getWeight<SM_gu_ttxu::CPPProcess>(SM_gu_ttxu::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    } else if (f_pid.size() == 2) {
      if (f_pid[1] == -2 && i2_pid == -2)
        return getWeight<SM_gux_ttxgux::CPPProcess>(SM_gux_ttxgux::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
      if (f_pid[1] == 2  && i2_pid == 2)
        return getWeight<SM_gu_ttxgu::CPPProcess>(SM_gu_ttxgu::process, i1_pid, i2_pid, i1, i2, t, tbar, f, Q2);
    }
  }
  std::cout << "WARNING: Reached end of getSMWeight without a weight! This cannot happen. i1 = " << i1_pid << ", i2 = " << i2_pid;
  for (unsigned int k = 0; k < f_pid.size(); ++k) {
    std::cout << ", f" << k << " = " << f_pid[k];
  }
  std::cout << std::endl;
  exit(-1);
  return 0;
}


